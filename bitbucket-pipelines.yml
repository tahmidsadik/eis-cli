image: golang:1.24

definitions:
  caches:
    gomodules: $GOPATH/pkg/mod
    golangci: ~/.cache/golangci-lint

  steps:
    - step: &build-step
        name: Build
        caches:
          - gomodules
        script:
          # Build binary
          - go build -o eiscli .

          # Verify binary
          - ./eiscli --version

    - step: &lint-step
        name: Lint and Format Check
        caches:
          - gomodules
          - golangci
        script:
          # Install golangci-lint (use specific version compatible with .golangci.yml)
          - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
          - export PATH=$PATH:$(go env GOPATH)/bin

          # Run gofmt check
          - |
            if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
              echo "Code is not formatted. Run 'gofmt -s -w .'"
              gofmt -s -d .
              exit 1
            fi

          # Run go vet
          - go vet ./...

          # Run golangci-lint with explicit config file
          - golangci-lint run --config .golangci.yml --timeout=5m

    - step: &test-step
        name: Run Tests
        caches:
          - gomodules
        script:
          # Run tests with race detector and coverage
          - go test -v -race -coverprofile=coverage.out ./...

          # Upload coverage to Codecov
          - |
            if [ -f coverage.out ]; then
              bash <(curl -s https://codecov.io/bash) -f coverage.out || echo "Codecov upload failed (non-blocking)"
            fi

    - step: &security-step
        name: Security Scan
        image: zricethezav/gitleaks:latest
        script:
          # Run Gitleaks scan (will fail if leaks are detected)
          - gitleaks detect --source . --verbose --no-banner

    - step: &build-release-step
        name: Build Release with OAuth
        caches:
          - gomodules
        variables:
          BITBUCKET_OAUTH_CLIENT_ID: ${OAUTH_CLIENT_ID}
          BITBUCKET_OAUTH_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET}
        script:
          # OAuth credentials are injected from repository variables
          # Build release binary with OAuth credentials baked in
          - make build-release

          # Verify OAuth credentials were injected
          - make verify-oauth-build

          # Show binary info
          - ls -lh ./eiscli
          - file ./eiscli
        artifacts:
          - eiscli

    - step: &build-multi-platform-step
        name: Build Multi-Platform Release Binaries
        caches:
          - gomodules
        variables:
          BITBUCKET_OAUTH_CLIENT_ID: ${OAUTH_CLIENT_ID}
          BITBUCKET_OAUTH_CLIENT_SECRET: ${OAUTH_CLIENT_SECRET}
        script:
          # Get version from git tag or commit
          - export VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          - echo "Building version:$VERSION"

          # OAuth credentials are injected from repository variables via step variables
          # Build for all platforms
          - make build-linux-amd64
          - make build-darwin-amd64
          - make build-darwin-arm64

          # Create latest binaries
          - make create-latest-binaries

          # List built binaries
          - ls -lh eiscli-*

          # Export version for use in upload step
          - echo "VERSION=${VERSION}" > version.env
        artifacts:
          - eiscli-linux-amd64-*
          - eiscli-darwin-amd64-*
          - eiscli-darwin-arm64-*
          - version.env

    - step: &upload-downloads-step
        name: Upload to Bitbucket Downloads
        variables:
          VERSION: ${BITBUCKET_TAG}
        script:
          # Load version from artifact or use BITBUCKET_TAG
          # Export VERSION so pipes can access it
          - |
            if [ -f version.env ]; then
              source version.env
            else
              export VERSION=${BITBUCKET_TAG}
            fi
            # Ensure VERSION is exported for pipes
            export VERSION
            echo "Uploading version $VERSION to Downloads..."

          # List all available files to debug
          - |
            echo "Available files in current directory:"
            ls -lah
            echo ""
            echo "Looking for eiscli binaries:"
            ls -lah eiscli-* 2>/dev/null || echo "No eiscli files found"
            echo "VERSION variable: $VERSION"

          # Verify versioned binaries exist before uploading
          - |
            LINUX_FILE="eiscli-linux-amd64-${VERSION}"
            DARWIN_AMD64_FILE="eiscli-darwin-amd64-${VERSION}"
            DARWIN_ARM64_FILE="eiscli-darwin-arm64-${VERSION}"

            echo "Checking for binaries:"
            echo "  Linux: $LINUX_FILE"
            echo "  Darwin amd64: $DARWIN_AMD64_FILE"
            echo "  Darwin arm64: $DARWIN_ARM64_FILE"

            # Verify files exist
            if [ ! -f "$LINUX_FILE" ] || [ ! -f "$DARWIN_AMD64_FILE" ] || [ ! -f "$DARWIN_ARM64_FILE" ]; then
              echo "ERROR: One or more versioned binaries not found"
              echo "Available files:"
              ls -lah eiscli-* 2>/dev/null || echo "No eiscli files found"
              exit 1
            fi

            echo "✓ All versioned binaries found"

          # Upload versioned binaries
          # Upload Linux binary (versioned)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-linux-amd64-${VERSION}"

          # Upload macOS Intel binary (versioned)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-darwin-amd64-${VERSION}"

          # Upload macOS Apple Silicon binary (versioned)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-darwin-arm64-${VERSION}"

          # Verify latest binaries exist before uploading
          - |
            if [ ! -f "eiscli-linux-amd64-latest" ] || [ ! -f "eiscli-darwin-amd64-latest" ] || [ ! -f "eiscli-darwin-arm64-latest" ]; then
              echo "ERROR: One or more latest binaries not found"
              echo "Available files matching pattern:"
              ls -lah eiscli-*-latest 2>/dev/null || echo "No matching files"
              exit 1
            fi
            echo "✓ All latest binaries found"

          # Upload latest binaries
          # Upload Linux binary (latest)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-linux-amd64-latest"

          # Upload macOS Intel binary (latest)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-darwin-amd64-latest"

          # Upload macOS Apple Silicon binary (latest)
          - pipe: atlassian/bitbucket-upload-file:0.7.5
            variables:
              BITBUCKET_USERNAME: $ATLASSIAN_ACCOUNT_EMAIL
              BITBUCKET_APP_PASSWORD: $ATLASSIAN_API_TOKEN
              FILENAME: "eiscli-darwin-arm64-latest"

          - echo "✓ All platform binaries (versioned and latest) uploaded to Downloads section"

pipelines:
  default:
    - step: *build-step
    - step: *lint-step
    - step: *test-step

  branches:
    main:
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-multi-platform-step
    master:
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-multi-platform-step

  pull-requests:
    "**":
      - step: *build-step
      - step: *lint-step
      - step: *test-step

  tags:
    "v*":
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-multi-platform-step
      - step: *upload-downloads-step
