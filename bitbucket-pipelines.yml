image: golang:1.24

definitions:
  caches:
    gomodules: $GOPATH/pkg/mod
    golangci: ~/.cache/golangci-lint
  
  steps:
    - step: &build-step
        name: Build
        caches:
          - gomodules
        script:
          # Build binary
          - go build -o eiscli .
          
          # Verify binary
          - ./eiscli --version
    
    - step: &lint-step
        name: Lint and Format Check
        caches:
          - gomodules
          - golangci
        script:
          # Install golangci-lint (use specific version compatible with .golangci.yml)
          - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
          - export PATH=$PATH:$(go env GOPATH)/bin
          
          # Run gofmt check
          - |
            if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
              echo "Code is not formatted. Run 'gofmt -s -w .'"
              gofmt -s -d .
              exit 1
            fi
          
          # Run go vet
          - go vet ./...
          
          # Run golangci-lint with explicit config file
          - golangci-lint run --config .golangci.yml --timeout=5m
    
    - step: &test-step
        name: Run Tests
        caches:
          - gomodules
        script:
          # Run tests with race detector and coverage
          - go test -v -race -coverprofile=coverage.out ./...
          
          # Upload coverage to Codecov
          - |
            if [ -f coverage.out ]; then
              bash <(curl -s https://codecov.io/bash) -f coverage.out || echo "Codecov upload failed (non-blocking)"
            fi
    
    - step: &security-step
        name: Security Scan
        image: zricethezav/gitleaks:latest
        script:
          # Run Gitleaks scan (will fail if leaks are detected)
          - gitleaks detect --source . --verbose --no-banner
    
    - step: &build-release-step
        name: Build Release with OAuth
        caches:
          - gomodules
        script:
          # OAuth credentials are injected from repository variables
          - export BITBUCKET_OAUTH_CLIENT_ID=$OAUTH_CLIENT_ID
          - export BITBUCKET_OAUTH_CLIENT_SECRET=$OAUTH_CLIENT_SECRET
          
          # Build release binary with OAuth credentials baked in
          - make build-release
          
          # Verify OAuth credentials were injected
          - make verify-oauth-build
          
          # Show binary info
          - ls -lh ./eiscli
          - file ./eiscli
        artifacts:
          - eiscli

pipelines:
  default:
    - step: *build-step
    - step: *lint-step
    - step: *test-step
  
  branches:
    main:
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-release-step
    master:
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-release-step
  
  pull-requests:
    '**':
      - step: *build-step
      - step: *lint-step
      - step: *test-step
  
  tags:
    'v*':
      - step: *build-step
      - step: *lint-step
      - step: *test-step
      - step: *build-release-step
      - step:
          name: Create Release
          script:
            - echo "Creating release for ${BITBUCKET_TAG}"
            - echo "Binary artifact available for download"
            # Add your release creation logic here (e.g., upload to S3, create GitHub release, etc.)
